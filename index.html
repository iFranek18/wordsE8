<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E8 CyberQuest: Battle Royale</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Inter:wght@400;800&display=swap" rel="stylesheet">
    <style>
        :root { --p: #7289da; --neon: #00f2ff; --bg: #05050a; --card: rgba(25, 25, 45, 0.95); }
        body { margin:0; font-family: 'Inter', sans-serif; background: var(--bg); color: #fff; overflow: hidden; height: 100vh; }
        .rgb-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #000; overflow: hidden; }
        .line { position: absolute; width: 2px; height: 40vh; filter: blur(2px); animation: move linear infinite; opacity: 0.4; }
        @keyframes move { 0% { transform: translateY(-110%) rotate(5deg); } 100% { transform: translateY(110vh) rotate(5deg); } }

        .app { max-width: 480px; margin: 0 auto; padding: 15px; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* TROPHY ROAD */
        .road-scroll { display: flex; overflow-x: auto; gap: 15px; padding: 10px; background: rgba(0,0,0,0.4); border-radius: 15px; border: 1px solid #333; margin-bottom: 15px; scrollbar-width: none; }
        .node { flex: 0 0 65px; text-align: center; }
        .node-box { width: 55px; height: 55px; background: var(--card); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; border: 2px solid #444; }
        .unlocked .node-box { border-color: var(--neon); box-shadow: 0 0 10px var(--neon); }

        /* UI BUTTONS */
        button { width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: 800; cursor: pointer; margin-top: 8px; font-family: 'Orbitron'; text-transform: uppercase; }
        .btn-blue { background: linear-gradient(135deg, #00d2ff, #3a7bd5); color: white; }
        .btn-multi { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        
        /* MULTIPLAYER HUD */
        .player-row { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; font-size: 0.8rem; }
        .p-bar { flex: 1; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
        .p-fill { height: 100%; background: var(--neon); transition: 0.3s; width: 0%; }

        input { width: 100%; padding: 16px; border-radius: 12px; border: 2px solid #333; background: #000; color: var(--neon); font-size: 1.1rem; text-align: center; font-family: 'Orbitron'; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="rgb-bg" id="rgb-container"></div>

<div class="app" id="screen-menu">
    <div class="road-scroll" id="road-content"></div>
    <div style="background:var(--card); padding:15px; border-radius:20px; border:1px solid var(--p); display:flex; align-items:center; gap:12px; margin-bottom:10px">
        <div style="font-size:2rem; width:50px; height:50px; background:#111; border-radius:10px; display:flex; align-items:center; justify-content:center; border:2px solid var(--neon)" id="p-avatar">üë∂üèª</div>
        <div style="flex:1">
            <h2 id="p-name" style="margin:0; font-size:0.9rem; font-family:'Orbitron'">GRACZ</h2>
            <div style="font-size:0.8rem">üèÜ <span id="p-cups">0</span> | üí∞ <span id="p-coins">0</span> | üí£ <span id="p-bombs">0</span></div>
        </div>
        <div onclick="showScreen('screen-settings')" style="cursor:pointer">‚öôÔ∏è</div>
    </div>
    <button class="btn-blue" onclick="startMode('practice')">NAUKA</button>
    <button class="btn-multi" onclick="showScreen('screen-multi-lobby')">BATTLE ROYALE üåê</button>
    <div style="background:var(--card); border-radius:15px; padding:12px; margin-top:10px; flex:1; overflow-y:auto">
        <h4 style="margin:0 0 10px 0; font-family:'Orbitron'; font-size:0.6rem; color:var(--neon)">RANKING LIDER√ìW</h4>
        <div id="leader-list"></div>
    </div>
</div>

<div class="app hidden" id="screen-multi-lobby">
    <button onclick="exitGame()">POWR√ìT</button>
    <div id="setup-view">
        <h2 style="font-family:'Orbitron'; text-align:center">POK√ìJ GIER</h2>
        <button class="btn-blue" onclick="createRoom()">STW√ìRZ NOWY POK√ìJ</button>
        <div style="margin: 20px 0">
            <input type="text" id="join-input" placeholder="WPISZ KOD">
            <button class="btn-multi" style="margin-top:5px" onclick="joinRoom()">DO≈ÅƒÑCZ DO EKIPY</button>
        </div>
    </div>

    <div id="room-view" class="hidden">
        <div style="text-align:center; background:var(--card); padding:15px; border-radius:15px; border:2px solid var(--neon)">
            <small>KOD POKOJU:</small>
            <h1 id="display-code" style="font-family:'Orbitron'; margin:5px 0; color:var(--neon)">----</h1>
        </div>
        <h4 style="font-family:'Orbitron'; margin:20px 0 10px 0">GRACZE W POKOJU:</h4>
        <div id="player-list"></div>
        <button id="start-btn" class="btn-blue hidden" onclick="startBattle()">START GRY! üî•</button>
        <p id="wait-msg" style="text-align:center; font-size:0.8rem; color:#888">Czekamy na Hosta...</p>
    </div>
</div>

<div class="app hidden" id="screen-game">
    <div id="battle-stats" style="margin-bottom:20px"></div>
    <div id="g-word" style="font-size: 1.8rem; margin: 20px 0; font-weight:900; text-align:center; font-family:'Orbitron'">---</div>
    <input type="text" id="g-input" placeholder="T≈ÅUMACZ SZYBKO!" autocomplete="off">
    <div id="g-feedback" style="margin: 15px 0; text-align:center; font-weight:bold; min-height:20px"></div>
    <div style="display:flex; gap:10px">
        <button class="btn-blue" style="background:#f1c40f" onclick="useBomb()">POMOC üí£</button>
        <button style="background:transparent; color:#555" onclick="exitGame()">WYJD≈π</button>
    </div>
</div>

<script>
// --- FIREBASE ---
const firebaseConfig = {
    apiKey: "AIzaSyCREz6ZMk86TW-dASBLNIHUTr5XDXZrTPE",
    authDomain: "english-game-d3ccd.firebaseapp.com",
    databaseURL: "https://english-game-d3ccd-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "english-game-d3ccd",
    storageBucket: "english-game-d3ccd.firebasestorage.app",
    messagingSenderId: "314380492870",
    appId: "1:314380492870:web:4efbbe6b98fe0ff45cea47"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- DATA ---
const WORDS = [{en:"I", pl:"ja"}, {en:"dog", pl:"pies"}, {en:"cat", pl:"kot"}, {en:"mother", pl:"mama"}, {en:"apple", pl:"jablko"}, {en:"water", pl:"woda"}, {en:"school", pl:"szkola"}, {en:"book", pl:"ksiazka"}, {en:"car", pl:"samochod"}, {en:"sun", pl:"slonce"}];

// --- STATE ---
let myId = localStorage.getItem('e8_uuid') || 'u_' + Math.random().toString(36).substr(2, 9);
localStorage.setItem('e8_uuid', myId);
let user = JSON.parse(localStorage.getItem('e8_br_v1')) || { name: "GRACZ", avatar: "üë∂üèª", cups: 0, coins: 50, bombs: 2, claimed: [] };
let currentRoom = null;
let gameIdx = 0;
let isHost = false;

function normalize(s) { return s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/≈Ç/g, "l").trim(); }

function save() {
    localStorage.setItem('e8_br_v1', JSON.stringify(user));
    db.ref('players/' + myId).set({ name: user.name, avatar: user.avatar, cups: user.cups });
    updateUI();
}

function updateUI() {
    document.getElementById('p-name').textContent = user.name;
    document.getElementById('p-avatar').textContent = user.avatar;
    document.getElementById('p-cups').textContent = user.cups;
    document.getElementById('p-coins').textContent = user.coins;
    document.getElementById('p-bombs').textContent = user.bombs;
}

// --- MULTI-BATTLE LOGIC ---
function createRoom() {
    isHost = true;
    const code = Math.floor(1000 + Math.random() * 8999);
    currentRoom = code;
    db.ref('rooms/' + code).set({
        host: myId,
        status: 'lobby',
        players: { [myId]: { name: user.name, avatar: user.avatar, prog: 0 } }
    });
    showRoomView(code);
}

function joinRoom() {
    const code = document.getElementById('join-input').value;
    if(!code) return;
    db.ref('rooms/' + code).once('value', snap => {
        if(snap.exists()) {
            currentRoom = code;
            db.ref(`rooms/${code}/players/${myId}`).set({ name: user.name, avatar: user.avatar, prog: 0 });
            showRoomView(code);
        } else alert("POK√ìJ NIE ISTNIEJE!");
    });
}

function showRoomView(code) {
    document.getElementById('setup-view').classList.add('hidden');
    document.getElementById('room-view').classList.remove('hidden');
    document.getElementById('display-code').textContent = code;
    
    db.ref('rooms/' + code).on('value', snap => {
        const data = snap.val();
        if(!data) return;
        
        // Lista graczy w lobby
        const pList = Object.values(data.players || {});
        document.getElementById('player-list').innerHTML = pList.map(p => `
            <div class="player-row"><span>${p.avatar}</span> <b>${p.name}</b> <span style="margin-left:auto; color:lime">GOTOWY</span></div>
        `).join('');

        if(isHost) document.getElementById('start-btn').classList.remove('hidden');
        
        // Start gry
        if(data.status === 'playing' && gameIdx === 0) {
            showScreen('screen-game');
            loadQ();
        }

        // Aktualizacja paska bitwy
        if(data.status === 'playing') {
            document.getElementById('battle-stats').innerHTML = Object.entries(data.players).map(([id, p]) => `
                <div style="font-size:0.7rem; margin-top:5px">${p.name} (${p.prog}/10)</div>
                <div class="p-bar"><div class="p-fill" style="width:${p.prog*10}%; background:${id===myId?'var(--neon)':'#ff416c'}"></div></div>
            `).join('');
            
            // Sprawd≈∫ czy kto≈õ wygra≈Ç
            Object.values(data.players).forEach(p => {
                if(p.prog >= 10 && data.winner === undefined) {
                    db.ref(`rooms/${currentRoom}`).update({ winner: p.name });
                    alert("KONIEC! WYGRA≈Å: " + p.name);
                    exitGame();
                }
            });
        }
    });
}

function startBattle() {
    db.ref(`rooms/${currentRoom}`).update({ status: 'playing' });
}

function loadQ() {
    document.getElementById('g-word').textContent = WORDS[gameIdx].en.toUpperCase();
    document.getElementById('g-input').value = "";
    document.getElementById('g-feedback').textContent = "";
}

document.getElementById('g-input').onkeydown = e => {
    if(e.key === 'Enter') {
        if(normalize(e.target.value) === normalize(WORDS[gameIdx].pl)) {
            gameIdx++;
            db.ref(`rooms/${currentRoom}/players/${myId}`).update({ prog: gameIdx });
            if(gameIdx < 10) loadQ();
            else {
                user.cups += 50;
                save();
            }
        } else {
            document.getElementById('g-feedback').textContent = "B≈ÅƒÑD!";
            document.getElementById('g-feedback').style.color = "red";
        }
    }
}

function exitGame() {
    if(currentRoom) db.ref(`rooms/${currentRoom}/players/${myId}`).remove();
    location.reload();
}

function showScreen(id) { document.querySelectorAll('.app').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
function updateProfileName() { user.name = document.getElementById('set-name').value.toUpperCase(); save(); }
function useBomb() { if(user.bombs > 0) { user.bombs--; alert("START: " + WORDS[gameIdx].pl[0]); save(); } }

// --- INIT ---
const container = document.getElementById('rgb-container');
for(let i=0; i<15; i++) {
    let l = document.createElement('div'); l.className = 'line';
    l.style.left = Math.random()*100+'%'; l.style.background = `linear-gradient(to bottom, transparent, ${['#00f2ff','#f5576c','#7289da'][i%3]}, transparent)`;
    l.style.animationDuration = (Math.random()*3+2)+'s'; container.appendChild(l);
}
updateUI();
</script>
</body>
</html>
